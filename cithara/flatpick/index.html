<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://kit.fontawesome.com/8e7dc2ee26.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/cithara/assets/css/main.css">
    <link rel="stylesheet" href="/cithara/assets/css/header.css">
    <title>Cithara - A Guitar Web Application</title>
</head>

<body>
    <nav>
        <div class="nav-top-bar">
            <ul class="start">
                <li class="button" onclick="previous()">
                    <span><i class="fa-solid fa-arrow-left"></i></span>
                </li>
                <li class="text">
                    <span>Flatpick</span>
                </li>
            </ul>
            <ul class="center justify">
            </ul>
            <ul class="end">
                <li class="button" onclick="fullscreen()">
                    <span><i class="fa-solid fa-expand"></i></span>
                </li>
            </ul>
        </div>
    </nav>
    <main>
        <link rel="stylesheet" href="/cithara/assets/css/playstyle.css">
        <section id="flatpickContainer">
            
            <svg viewBox="0 0 1520 720">
                <path
                    d="M100 320 q 0 300 100 500 q 0 0 1500 0 q 0 0 0 -500 M100 320 q 0 -300 100 -500 q 0 0 1500 0 q 0 0 0 500"
                    fill="rgb(229, 194, 156)"></path>
                <circle cx="760" cy="320" r="300" fill="white"></circle>
                <circle cx="760" cy="320" r="200" fill="rgb(74, 63, 50)"></circle>
                <rect x="0" y="170" rx="4" ry="4" width="560" height="300" fill="rgb(160, 122, 81)"></rect>
                <rect x="50" y="1750" rx="4" ry="4" width="10" height="300" fill="rgb(74, 63, 50)"></rect>
                <rect x="150" y="170" rx="4" ry="4" width="10" height="300" fill="rgb(74, 63, 50)"></rect>
                <rect x="250" y="170" rx="4" ry="4" width="10" height="300" fill="rgb(74, 63, 50)"></rect>
                <rect x="350" y="170" rx="4" ry="4" width="10" height="300" fill="rgb(74, 63, 50)"></rect>
                <rect x="450" y="170" rx="4" ry="4" width="10" height="300" fill="rgb(74, 63, 50)"></rect>
                <rect x="550" y="170" rx="4" ry="4" width="10" height="300" fill="rgb(74, 63, 50)"></rect>
                <rect x="1237.5" y="87.5" rx="8" ry="8" width="100" height="475" fill="rgb(160, 122, 81)"></rect>
                <rect x="1262.5" y="105" rx="8" ry="8" width="50" height="425" fill="white"></rect>
                <circle cx="1287.5" cy="197.5" r="10" fill="rgb(54, 45, 37)"></circle>
                <circle cx="1287.5" cy="247.5" r="10" fill="rgb(54, 45, 37)"></circle>
                <circle cx="1287.5" cy="297.5" r="10" fill="rgb(54, 45, 37)"></circle>
                <circle cx="1287.5" cy="347.5" r="10" fill="rgb(54, 45, 37)"></circle>
                <circle cx="1287.5" cy="397.5" r="10" fill="rgb(54, 45, 37)"></circle>
                <circle cx="1287.5" cy="447.5" r="10" fill="rgb(54, 45, 37)"></circle>

                <rect class="string" x="0" y="445" rx="5" width="1287.5" height="4" fill="rgb(54, 45, 37)"></rect>
                <rect class="string" x="0" y="395" rx="5" width="1287.5" height="5" fill="rgb(54, 45, 37)"></rect>
                <rect class="string" x="0" y="345" rx="5" width="1287.5" height="6" fill="rgb(54, 45, 37)"></rect>
                <rect class="string" x="0" y="295" rx="5" width="1287.5" height="7" fill="rgb(54, 45, 37)"></rect>
                <rect class="string" x="0" y="245" rx="5" width="1287.5" height="8" fill="rgb(54, 45, 37)"></rect>
                <rect class="string" x="0" y="195" rx="5" width="1287.5" height="10" fill="rgb(54, 45, 37)"></rect>
                <g></g>
            </svg>
            <div id="flatpickSetting">  
                <div id="flatpickBPM">
                    <div>
                        <span id="flatpickBPMValue" style="width: 4rem;">BPM</span>
                    </div>
                    <div>
                        <span>
                            <input type="range" id="flatpickRange" min="30" max="150" value="90">
                        </span>
                    </div>
                </div>
                <div id="flatpickPatternSelect">
                    <span>
                        <select id="select">
                            <option value="-1" default="">Pattern</option>
                        <option value="0">B 3 2 1</option><option value="1">B 3 2 3 1 3 2 3</option><option value="2">B 3 2 1 3 2 3 1</option><option value="3">B 3 2 1 3 2 3 2</option></select>
                    </span>
                </div>
                <div style="justify-content: center;">
                    <div class="button">
                        <select id="base">
                            <option default="" value="0">Base</option>
                            <option value="5">E G</option>
                            <option value="4">C A B</option>
                            <option value="3">D F</option>
                        </select>
                    </div>
                    <div id="flatpickMute">
                        <input id="muteCheckbox" type="checkbox">
                        <span id="muteDisplay" style="color: var(--green)">
                            <svg class="svg-inline--fa fa-volume-high fa-xl" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="volume-high" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" data-fa-i2svg=""><path fill="currentColor" d="M533.6 32.5C598.5 85.3 640 165.8 640 256s-41.5 170.8-106.4 223.5c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C557.5 398.2 592 331.2 592 256s-34.5-142.2-88.7-186.3c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zM473.1 107c43.2 35.2 70.9 88.9 70.9 149s-27.7 113.8-70.9 149c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C475.3 341.3 496 301.1 496 256s-20.7-85.3-53.2-111.8c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zm-60.5 74.5C434.1 199.1 448 225.9 448 256s-13.9 56.9-35.4 74.5c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C393.1 284.4 400 271 400 256s-6.9-28.4-17.7-37.3c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zM301.1 34.8C312.6 40 320 51.4 320 64V448c0 12.6-7.4 24-18.9 29.2s-25 3.1-34.4-5.3L131.8 352H64c-35.3 0-64-28.7-64-64V224c0-35.3 28.7-64 64-64h67.8L266.7 40.1c9.4-8.4 22.9-10.4 34.4-5.3z"></path></svg><!-- <i class="fa-solid fa-volume-high fa-xl"></i> Font Awesome fontawesome.com -->
                        </span>
                    </div>
                    <div id="flatpickPlay">
                        <input id="playCheckbox" type="checkbox">
                        <span id="playDisplay" style="color: var(--blue)">
                            <svg class="svg-inline--fa fa-play fa-xl" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="play" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" data-fa-i2svg=""><path fill="currentColor" d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"></path></svg><!-- <i class="fa-solid fa-play fa-xl"></i> Font Awesome fontawesome.com -->
                        </span>
                    </div>
                </div>
            </div>
            <audio src="/cithara/assets/audio/E4.mp3" class="audio"></audio>
            <audio src="/cithara/assets/audio/B3.mp3" class="audio"></audio>
            <audio src="/cithara/assets/audio/G3.mp3" class="audio"></audio>
            <audio src="/cithara/assets/audio/D3.mp3" class="audio"></audio>
            <audio src="/cithara/assets/audio/A2.mp3" class="audio"></audio>
            <audio src="/cithara/assets/audio/E2.mp3" class="audio"></audio>
        
        </section>
    </main>
    <script src="/cithara/assets/javascript/main.js"></script>
    <script>
    const flatpicks = [    
    {
        "songName": "B 3 2 1",
        "songPattern": ["B", "-", "3", "-", "2", "-", "1", "-"]
        
    },
    
    {
        "songName": "B 3 2 3 1 3 2 3",
        "songPattern": ["B", "3", "2", "3", "1", "3", "2", "3"]
    },

    {
        "songName": "B 3 2 1 3 2 3 1",
        "songPattern": ["B", "3", "2", "1", "3", "2", "3", "1"]
    },

    {
        "songName": "B 3 2 1 3 2 3 2",
        "songPattern": ["B", "3", "2", "1", "3", "2", "3", "2"]
    }
]
    </script>
    <script>

const slider = document.querySelector("#flatpickRange");
        const sliderValue = document.querySelector('#flatpickBPMValue');
        let timeoutId;
        let bpm = slider.value;
        let bpmInterval = (60 / bpm) * 1000;

        let rand;

        let audio = document.querySelectorAll(".audio");

        let sliderRect = slider.getBoundingClientRect();
        let sliderValueRect = sliderValue.getBoundingClientRect();

        slider.addEventListener('input', () => {
            const value = slider.value;
            sliderValue.textContent = value;

            // Clear the previous timeout (if it exists)
            clearTimeout(timeoutId);

            // Set a new timeout to hide the sliderValue after 3 seconds
            timeoutId = setTimeout(function() {
                sliderValue.textContent = "BPM";
            }, 3000);

            bpm = slider.value;
            bpmInterval = (60 / bpm) * 1000;
        });

        const string = document.querySelectorAll(".string");

        const beatValue = [0, 0, 0, 0, 0, 0 ,0, 0];

        const select = document.querySelector("#select");

        flatpicks.forEach((item, index) => {
            let option = document.createElement("option");
            option.text = item.songName;
            option.value = index;
            select.appendChild(option);
        });

        select.addEventListener("change", function() {
            if (parseInt(select.value) === -1 ) {
                beatValue.fill(0);
                return false;
            }
            
            beatValue.forEach((item, index) => {
                beatValue[index] = flatpicks[select.value].songPattern[index];
            });

            rand = Math.floor(Math.random() * 3 + 3);

            if (baseValue !== 0) {
                beatValue[0] = baseValue + 1;
            } else {
                beatValue[0] = rand;
            }

            displayOrder();
        });
        
        const base = document.querySelector("#base");

        baseValue = parseInt(base.value);

        base.addEventListener("change", function() {
            baseValue = parseInt(this.value);

            if (baseValue !== 0) {
                beatValue[0] = baseValue + 1;
            } else {
                beatValue[0] = rand;
            }

            displayOrder();
        })

        const muteCheckbox = document.querySelector("#muteCheckbox");
        const playCheckbox = document.querySelector("#playCheckbox");

        let mute = false;

        muteCheckbox.addEventListener("change", function() {

            mute = muteCheckbox.checked;

            muteDisplay = document.querySelector("#muteDisplay");

            if (mute) {
                mute = false;

                muteDisplay.style.color = "var(--green)";
                muteDisplay.innerHTML = "<i class='fa-solid fa-volume-high fa-xl'></i>";
            } else {
                mute = true;

                muteDisplay.style.color = "var(--red)";
                muteDisplay.innerHTML = "<i class='fa-solid fa-volume-xmark fa-xl'></i>";
            }
            
        });

        let playDisplay = document.querySelector("#playDisplay");

        let intervalId;

        playCheckbox.addEventListener("change", function() {
            play = playCheckbox.checked;
            changePlayButton();

            if (play) {
                // Start playing
                startPlayback();
            } else {
                // Stop playback
                stopPlayback();
            }
        });

        function startPlayback() {
            let index = 0;

            if (baseValue !== 0) {
                rand = baseValue;
            }

            intervalId = setInterval(function() {
                const value = beatValue[index];

                switch (value) {
                    case "B":
                        if(!mute) { 
                            audio[parseInt(beatValue[index])].currentTime = 0;
                            audio[parseInt(beatValue[index])].play(); 
                        }
                        highlightString(rand);
                        break;
                    case "-":
                        highlightString(8);
                        break;
                    default:
                        if(!mute) { 
                            audio[parseInt(beatValue[index]) - 1].currentTime = 0;
                            audio[parseInt(beatValue[index]) - 1].play(); 
                        }
                        highlightString(parseInt(beatValue[index]) - 1);
                        break;
                }

                index++;

                if (index >= beatValue.length) {
                    stopPlayback();
                }
            }, bpmInterval);
        }

        function stopPlayback() {
            clearInterval(intervalId); // Stop the playback interval
            playCheckbox.checked = false; // Uncheck the checkbox
            changePlayButton();
        }

        function highlightString(index) {
            string.forEach((item, i) => {
                if(i === index) {
                    if (i === 0) { string[i].style.fill = "var(--green)"; }
                    else if (i === 1) { string[i].style.fill = "var(--blue)";}
                    else if (i === 2) { string[i].style.fill = "var(--purple)";}
                    else if (i === 3) { string[i].style.fill = "var(--red)";}
                    else if (i === 4) { string[i].style.fill = "var(--red)";}
                    else if (i === 5) { string[i].style.fill = "var(--red)";}
                }
                else {
                    string[i].style.fill = "rgb(54, 45, 37)";
                }
            })
        }

        function changePlayButton() {
            if (playCheckbox.checked) {
                playDisplay.style.color = "var(--orange)";
                playDisplay.innerHTML = "<i class='fa-solid fa-pause fa-xl'></i>";
            } else {
                playDisplay.style.color = "var(--blue)";
                playDisplay.innerHTML = "<i class='fa-solid fa-play fa-xl'></i>";
            }
            setTimeout(() => { highlightString(8); }, 1000);
        }

        function displayOrder() {

            return false;
            const svg = document.querySelector("#flatpickContainer svg g");

            svg.textContent = "";

            let value = beatValue;

            if (baseValue !== 0) {
                value[0] === baseValue + 1;
            }

            let strings = new Array(6).fill(0);

            order = 1;

            value.forEach((item, index) => {
                if (item === "-") {
                    return false;
                }

                item--;

                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle")

                circle.setAttribute("cx", 1350 + (strings[item] * 50) + "");
                circle.setAttribute("cy", 325 - (item * 50) + "");
                circle.setAttribute("r", "24");
                circle.setAttribute("fill", "var(--black)");

                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");

                text.setAttribute("x", 1343.75 + (strings[item] * 50) + "");
                text.setAttribute("y", 331.25 - (item * 50) + "");
                text.setAttribute("font-size", "24")
                text.setAttribute("fill", "var(--white)");
                text.textContent = order;

                svg.appendChild(circle);
                svg.appendChild(text);

                strings[item]++;
                order++;
            });


        }
    
    </script>
</body>
</html>