<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://kit.fontawesome.com/8e7dc2ee26.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/cithara/assets/css/main.css">
    <link rel="stylesheet" href="/cithara/assets/css/header.css">
    <title>Cithara - A Guitar Web Application</title>
</head>

<body>
    <!-- --> 
    <!-- Header for navigating through pages -->   
    <!-- -->
    <header>
        <!-- Navigation on top of screen, position fixed -->
        <div class="topbar">
            <!-- Most left of screen -->
            <ul class="start">
                <li class="item button bars">
                    <span><i class="fa-solid fa-bars">Bars</i></span>
                </li>
                <li class="item home">
                    <span><img src="/cithara/assets/images/logo.png"></span>
                </li>
            </ul>
            <!-- -->
            <!-- Center of screen -->
            <ul class="center">
                <li class="item button qrcode" data-url="/tools/ar">
                    <span><i class="fa-solid fa-camera"></i></span>
                </li>
                <li class="item searchbar">
                    <input id="search" type="text" placeholder="Search" autocomplete="off">
                    <span class="clear"><i class="fa-solid fa-xmark"></i></span>
                    <span class="search"><i class="fa-solid fa-magnifying-glass"></i></span>
                </li>
                <li class="item button microphone">
                    <span><i class="fa-solid fa-microphone"></i></span>
                </li>
                <ul class="search-result">
                </ul>
            </ul>
            <!-- -->
            <!-- Most righ of screen -->
            <ul class="end">
                <li class="item button help">
                    <span><i class="fa-solid fa-circle-question"></i></span>
                </li>
                <li class="item button expand">
                    <span><i class="fa-solid fa-expand"></i></span>
                </li>
            </ul>
            <!-- -->
        </div>
        <!-- -->
        <!-- Navigation on side of screen, display offscreen until toggled-->
        <div class="sidebar"></div>
        <!-- -->
    </header>
    <script src="/cithara/assets/external/wordcut.min.js"></script>
    <script src="/cithara/assets/javascript/search.js"></script>
    <script src="/cithara/songs/songs.js"></script>
    <script></script>
    <script>
        /**
         * Main, mostly apply to overall contents
         */

        const dataUrlNodes = document.querySelectorAll("[data-url]");

        dataUrlNodes.forEach(node => {
            node.addEventListener("click", function () {
                const dataUrl = node.getAttribute("data-url");
                if (dataUrl) {
                    window.location.href = dataUrl;
                };
            })
        })

        /**
         * 
         */

        /**
         * Searchbar, defined how seachbar will interact
         */

        const searchInput = document.getElementById("search");
        const clearButton = document.querySelector(".searchbar .clear");
        const searchButton = document.querySelector(".searchbar .search");

        searchInput.addEventListener("input", function () {
            if (this.value) {
                clearButton.classList.add("active");
            } else {
                clearButton.classList.remove("active");
            }

            if (this.value === "") {
                searchbarResult(false);
                return;
            }

            results = searchMin(this.value, songs, 3);

            setTimeout(() => searchbarResult(results), 300);
        })

        clearButton.addEventListener("click", function () {
            searchInput.value = "";

            clearButton.classList.remove("active");
        })

        searchButton.addEventListener("click", function () {
            if (searchInput.value === "") {
                return;
            }
            window.location.href = `/cithara/songs/#${searchInput.value}`;
        })

        /**
         * Display array of results and create element under searchbar
         * @param { Array } Array of results
         */
        function searchbarResult(results) {
            const element = document.querySelector(".search-result");

            element.textContent = "";

            if (!results || results.length === 0) {
                element.classList.remove("active");

                return;
            }

            if (!element.classList.contains("active")) {
                element.classList.add("active");
            }

            results.forEach(result => {
                const list = document.createElement("li");
                list.classList.add("result")

                const link = document.createElement("a");
                link.href = `/cithara/songs/song.html#${result.id}`;

                const img = document.createElement("img");
                img.classList.add("image");
                img.src = `/cithara/songs/images/${result.image}`;

                const name = document.createElement("div");
                name.classList.add("name");
                name.textContent = result.name;

                link.appendChild(img);
                link.appendChild(name);

                list.appendChild(link);

                element.appendChild(list);
            });
        }

        //
        // --- Speech Recognition --- 
        //
        const recognition = new webkitSpeechRecognition() || new SpeechRecognition();
        const microphone = document.querySelector('.microphone');
        const timeoutDuration = 10000;

        let recognitionTimeout = false;;

        // Speech Recognition Setup
        recognition.lang = 'th';

        recognition.onresult = (event) => {
            const result = event.results[0][0].transcript;
            searchInput.value = result;

            const minResult = searchMin(result, songs, 3)

            setTimeout(() => searchbarResult(minResult, 300));

            clearTimeout(recognitionTimeout);
            recognitionTimeout = false;
        }

        microphone.addEventListener('click', function () {
            // If is not recording
            if(!recognitionTimeout) {
                recognition.start();
            
                microphone.classList.add("active");

                recognitionTimeout = setTimeout(() => {
                    recognition.stop();
                    
                    microphone.classList.remove("active");
                    recognitionTimeout = false;
                }, timeoutDuration)
            } else {
                recognition.stop();

                microphone.classList.remove("active");
                clearTimeout(recognitionTimeout);
                recognitionTimeout = false;
            }
        });

        // --- ---  --- //

        /**
         * 
         */
    </script>
</body>

</html>